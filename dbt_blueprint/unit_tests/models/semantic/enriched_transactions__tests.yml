unit_tests:
  - name: test__enriched_transactions__basic_enrichment
    description: "Test that transactions are enriched with user, card, and account details."
    model: enriched_transactions
    overrides:
      macros:
        # unit test this model in "full refresh" mode
        is_incremental: false 
    given:
      - input: ref('int_transactions')
        rows:
          - {transaction_uid: 'p2p_1', event_domain: 'p2p', event_state: 'captured', event_id_raw: '1', sender_user_id: 'user_1', receiver_user_id: 'user_2', sender_payment_source_id: 'card_1', receiver_payment_source_id: 'account_1', country_code: 'US', currency_code: 'USD', transaction_amount: 100.0, message: 'Test transaction', event_time: '2023-01-01 00:00:00', recorded_time: '2023-01-01 01:00:00'}
      - input: ref('int_users')
        rows:
          - {user_id: 'user_1', is_current: true}
          - {user_id: 'user_2', is_current: true}
      - input: ref('int_cards')
        rows:
          - {payment_source_id: 'card_1', status: 'active', provider: 'Visa', is_current: true}
      - input: ref('int_accounts')
        rows:
          - {payment_source_id: 'account_1', status: 'active', provider: 'Bank A', is_current: true}
    expect:
      rows:
        - {transaction_uid: 'p2p_1', event_domain: 'p2p', event_state: 'captured', event_id_raw: '1', sender_user_id: 'user_1', receiver_user_id: 'user_2', sender_card_status: 'active', sender_card_provider: 'Visa', receiver_account_status: 'active', receiver_account_provider: 'Bank A', transaction_amount: 100.0, event_time: '2023-01-01 00:00:00', recorded_time: '2023-01-01 01:00:00'}

  - name: test__enriched_transactions__missing_user
    description: "Test that transactions with missing user details are still included but without enrichment."
    model: enriched_transactions
    overrides:
      macros:
        # unit test this model in "full refresh" mode
        is_incremental: false 
    given:
      - input: ref('int_transactions')
        rows:
          - {transaction_uid: 'p2b_2', event_domain: 'p2b', event_state: 'failed', event_id_raw: '2', sender_user_id: 'user_3', receiver_user_id: 'user_4', sender_payment_source_id: 'card_2', receiver_payment_source_id: 'account_2', country_code: 'CA', currency_code: 'CAD', transaction_amount: 50.0, message: 'Failed transaction', event_time: '2023-01-02 00:00:00', recorded_time: '2023-01-02 01:00:00'}
      - input: ref('int_users')
        rows: []
      - input: ref('int_cards')
        rows:
          - {payment_source_id: 'card_2', status: 'inactive', provider: 'MasterCard', is_current: false}
      - input: ref('int_accounts')
        rows:
          - {payment_source_id: 'account_2', status: 'inactive', provider: 'Bank B', is_current: false}
    expect:
      rows:
        - {transaction_uid: 'p2b_2', event_domain: 'p2b', event_state: 'failed', event_id_raw: '2', sender_user_id: 'user_3', receiver_user_id: 'user_4', sender_card_status: null, sender_card_provider: null, receiver_account_status: null, receiver_account_provider: null, transaction_amount: 50.0, event_time: '2023-01-02 00:00:00', recorded_time: '2023-01-02 01:00:00'}